// pages/diagnosis/result/result.js

// === è¯Šæ–­æ¨¡æ¿ï¼ˆå®Œæ•´ç»“æ„ï¼‰ ===
const DIAGNOSTICS_CONFIG = {
  diagnosis_names: {
    "R1": "æ ¹è…ç—… Â· æ¹¿çƒ­å‹ï¼ˆç–«éœ‰å‹ï¼‰", "R2": "æ ¹è…ç—… Â· ç¼ºæ°§ç¡«åŒ–å‹", "R3": "è‚¥å®³ï¼ˆæ°®/ç›å®³ï¼‰",
    "R4": "å†œè¯è¯å®³ï¼ˆæ··é…/è¯å®³ï¼‰", "R5": "ç—…æ¯’ç—…ï¼ˆèŠ±å¶/æ–‘é©³ï¼‰", "R6": "åˆºå¸å¼å®³è™«å±å®³ï¼ˆè“Ÿé©¬/èšœè™«ï¼‰",
    "R7": "æ—¥ç¼ / å…‰å®³", "R8": "æ¸æ¶ / æ°´åˆ†è¿‡å¤š", "R9": "å¹²æ—± / æ°´åˆ†ä¸è¶³",
    "R10": "è¥å…»ç¼ºå¤±ï¼ˆå¾®é‡å…ƒç´ ï¼‰", "R11": "ç›å®³ / åœŸå£¤æ¯’å®³", "R12": "åœŸå£¤æ¿ç»“ / é€æ°”å·®"
  },

  diagnosis_templates: {
    "R1": {
      name: "æ ¹è…ç—… Â· æ¹¿çƒ­å‹ï¼ˆç–«éœ‰å‹ï¼‰",
      mechanism: "æ¹¿çƒ­éƒæ» + æ ¹åŒºç¼ºæ°§ï¼Œå±â€œæ¹¿çƒ­è¯â€ã€‚é›¨åé«˜æ¹¿ã€é€šæ°”ä¸è‰¯å¯¼è‡´ç–«éœ‰å…¥ä¾µã€‚",
      treatment: {
        acute: ["ç«‹å³å¼€æ²Ÿæ’æ°´ï¼Œæé«˜æ ¹åŒºå«æ°§", "åœæ­¢çŒæº‰ä¸æ–½è‚¥48â€“72å°æ—¶", "åˆ¨é™¤è…æ ¹ï¼Œæ’’å¹²åœŸå¸æ¹¿"],
        mid: ["æ–½æ¯è‰èŠ½å­¢æ†èŒ + åœ°è¡£èŠ½å­¢æ†èŒä¿®å¤æ ¹é™…", "è¡¥é’™é•ï¼Œæé«˜æ ¹ç³»æŠ—é€†æ€§"],
        long: ["æ–½è…ç†Ÿæœ‰æœºè´¨ã€æ”¹å–„å›¢ç²’ç»“æ„", "æå‡ç”°å—æ’æ°´èƒ½åŠ›ã€é¿å…è¿ä½œ"]
      }
    },
    "R2": {
      name: "æ ¹è…ç—… Â· ç¼ºæ°§ç¡«åŒ–å‹",
      mechanism: "åœŸå£¤é•¿æœŸç§¯æ°´ç¼ºæ°§ï¼Œå‡ºç°ç¡«åŒ–æ°¢æ ¹æ¯’ï¼Œæ ¹ç³»é»‘è…ã€‚",
      treatment: {
        acute: ["å¿«é€Ÿæ’æ°´ã€ç¿»æ¾åœŸå£¤å¢æ°§", "æ’’çŸ³ç°æˆ–åœŸå£¤è°ƒç†å‰‚é™ä½ç¡«åŒ–ç‰©"],
        mid: ["æ–½å…¥å¥½æ°§èŒç¾¤ï¼Œæ¢å¤æ ¹é™…åŠŸèƒ½"],
        long: ["å»ºè®¾æ’æ°´æ²Ÿç³»ï¼Œæé«˜ç•¦é¢"]
      }
    },
    "R3": {
      name: "è‚¥å®³ï¼ˆæ°®å®³/ç›å®³ï¼‰",
      mechanism: "è¿½æ–½æ°®è‚¥æˆ–åœŸå£¤ç›åˆ†è¿‡é«˜å¯¼è‡´æ ¹éƒ¨æ¸—é€å‹å¤±è¡¡ã€‚",
      treatment: {
        acute: ["ç«‹å³å¤§é‡çŒæ°´å†²æ·¡ç›åˆ†", "æš‚åœæ–½è‚¥ä¸å–·è¯"],
        mid: ["æ–½æµ·è—»é…¸ã€æ°¨åŸºé…¸ç¼“è§£è¯å®³", "è¡¥é’¾é’™ï¼Œä¿ƒè¿›ä¿®å¤"],
        long: ["å®è¡Œå°‘é‡å¤šæ¬¡æ–½è‚¥æ¨¡å¼"]
      }
    },
    "R4": {
      name: "è¯å®³ï¼ˆå†œè¯æ··é…æˆ–å–·è¯ä¸å½“ï¼‰",
      mechanism: "è¯å‰‚æµ“åº¦é«˜æˆ–æ··é…å†²çªå¯¼è‡´å¶ç‰‡ç¼ä¼¤ã€ç•¸å½¢ã€‚",
      treatment: {
        acute: ["ç«‹åˆ»åœæ­¢å–·è¯", "ç”¨æ¸…æ°´å†²æ´—å¶é¢"],
        mid: ["æ–½æœ‰æœºè´¨ä¸å¾®ç”Ÿç‰©è°ƒç†å‰‚ä¿®å¤"],
        long: ["åŠ å¼ºç”¨è¯åŸ¹è®­ã€ä¼˜åŒ–æ··é…è®°å½•"]
      }
    },
    "R5": {
      name: "ç—…æ¯’ç—…ï¼ˆèŠ±å¶/æ–‘é©³ï¼‰",
      mechanism: "ç”±èšœè™«ç­‰åˆºå¸å¼å®³è™«ä¼ æ’­ï¼Œå¯¼è‡´æ¤æ ªç³»ç»Ÿæ€§ç—…å˜ã€‚",
      treatment: {
        acute: ["æ‹”é™¤ä¸¥é‡ç—…æ ª", "æ§èšœæ§è“Ÿé©¬å‡å°‘ä¼ æ’­æº"],
        mid: ["è¡¥é’¾ã€ç¡¼é”Œå¢å¼ºä½“è´¨"],
        long: ["é€‰æŠ—ç—…æ¯’å“ç§ã€ä¸¥æ ¼è‹—æœ¨æ£€ç–«"]
      }
    },
    "R6": {
      name: "åˆºå¸å¼å®³è™«ï¼ˆè“Ÿé©¬/èšœè™«ï¼‰",
      mechanism: "è™«å®³åˆºå¸å¶è‚‰å¯¼è‡´è¤ªç»¿ã€çš±ç¼©ã€é’å‘³å¢å¼ºã€‚",
      treatment: {
        acute: ["æ–½ä½æ¯’æ€è™«å‰‚æˆ–é‡Šæ”¾å¤©æ•Œ"],
        mid: ["ä¿®å‰ªå—å®³å¶ã€è¡¥å……å…»åˆ†"],
        long: ["é»„è‰²æ¿/è“æ¿ç›‘æµ‹ä¸å¤©æ•Œä¿æŠ¤"]
      }
    },
    "R7": {
      name: "æ—¥ç¼ / å…‰å®³",
      mechanism: "å¼ºå…‰æš´æ™’å¯¼è‡´å¶ç‰‡æˆ–æœé¢ç¼ä¼¤ã€‚",
      treatment: {
        acute: ["é®é˜³ï¼ˆé®å…‰30%ï¼‰", "é¿å…æ­£åˆæ–½è¯"],
        mid: ["è¡¥é’™è¡¥ç¡¼å¢å¼ºæŠ—æ€§"],
        long: ["æ”¹å–„å† å½¢ï¼Œå‡å°‘æš´æ™’é¢"]
      }
    },
    "R8": {
      name: "æ¸æ¶ / æ°´åˆ†è¿‡å¤š",
      mechanism: "æ ¹åŒºæ·¹æ°´å¯¼è‡´æ°”æ»ï¼Œæ ¹å‘¼å¸å—é˜»ã€‚",
      treatment: {
        acute: ["ç«‹å³æ’æ°´ã€æš‚åœæµ‡æ°´"],
        mid: ["æ–½å¥½æ°§èŒã€æ”¹å–„é€šæ°”"],
        long: ["å»ºç«‹æ’æ°´ç³»ç»Ÿã€æé«˜ç•¦é¢"]
      }
    },
    "R9": {
      name: "å¹²æ—± / æ°´åˆ†ä¸è¶³",
      mechanism: "åœŸå£¤æ°´åˆ†ä¸è¶³å¯¼è‡´è’¸è…¾å¤±è¡¡ã€‚",
      treatment: {
        acute: ["å¾ªåºæ¸è¿›è¡¥æ°´", "è¦†ç›–åœ°è†œæˆ–ç§¸ç§†ä¿æ°´"],
        mid: ["æ”¹å–„ä¿æ°´ç»“æ„"],
        long: ["å¢åŠ æœ‰æœºè´¨ï¼Œæå‡ä¿æ°´æ€§"]
      }
    },
    "R10": {
      name: "è¥å…»ç¼ºå¤±ï¼ˆå¾®é‡å…ƒç´ ï¼‰",
      mechanism: "é“ã€é”Œã€é•ç­‰å…ƒç´ å¸æ”¶ä¸è¶³å¯¼è‡´å…¸å‹é»„åŒ–ç—‡ã€‚",
      treatment: {
        acute: ["å¶é¢å–·æ–½é“é”Œç¡¼"],
        mid: ["åœŸå£¤æ£€æµ‹åå®šåˆ¶æ–½è‚¥æ–¹æ¡ˆ"],
        long: ["å¹³è¡¡æ–½è‚¥ã€å»ºç«‹è¥å…»ç®¡ç†åˆ¶åº¦"]
      }
    },
    "R11": {
      name: "ç›å®³ / åœŸå£¤æ¯’åŒ–",
      mechanism: "åœŸå£¤ EC é«˜æˆ–ç›åˆ†ç§¯ç´¯å¯¼è‡´æ¸—é€å‹èƒè¿«ã€‚",
      treatment: {
        acute: ["å¤§é‡çŒæ°´å†²æ·¡ç›åˆ†", "æ’’çŸ³è†äº¤æ¢ç›åŸº"],
        mid: ["ç¿»è€•æ’ç›"],
        long: ["ç›‘æµ‹çŒæº‰æ°´è´¨ä¸EC"]
      }
    },
    "R12": {
      name: "åœŸå£¤æ¿ç»“ / é€æ°”å·®",
      mechanism: "è€•ä½œä¸å½“å¯¼è‡´åœŸå±‚ç¡¬åŒ–ã€æ ¹ç³»å—é™ã€‚",
      treatment: {
        acute: ["æµ…è€•æ¾åœŸå‡å°‘æ¿ç»“"],
        mid: ["æ–½è…ç†Ÿæœ‰æœºè´¨æ”¹å–„åœŸå£¤"],
        long: ["æ¨å¹¿ä¿æŠ¤æ€§è€•ä½œ"]
      }
    }
  }
};

Page({

  data: {
    diagnosis: '',
    diagnosisName: '',
    mechanism: '',
    treatment: { acute: [], mid: [], long: [] },
    scores: {},
    correctedScores: {},
    phenology: '',
    month: ''
  },

  // ==============================================
  // ğŸ¯ã€é‡æ„çš„ onLoad â€”â€” å®Œæ•´å¤„ç† options.resultã€‘
  // ==============================================
  onLoad(options) {
    console.log("ã€ResultPageã€‘æ¥æ”¶åˆ°çš„ options:", options);

    if (!options.result) {
      console.error("âŒ æœªæ”¶åˆ° result å‚æ•°ï¼");
      wx.showToast({ title: "è¯Šæ–­ç»“æœä¼ è¾“å¤±è´¥", icon: "none" });
      return;
    }

    // è§£æä¼ å…¥çš„è¯Šæ–­ JSON å­—ç¬¦ä¸²
    let resultObj = {};
    try {
      resultObj = JSON.parse(decodeURIComponent(options.result));
      console.log("ã€ResultPageã€‘è§£æåçš„ result å¯¹è±¡:", resultObj);
    } catch (e) {
      console.error("âŒ result è§£æå¤±è´¥:", e);
      wx.showToast({ title: "è¯Šæ–­æ•°æ®æŸå", icon: "none" });
      return;
    }

    const diagnosis = resultObj.diagnosis || "R1";
    const phenology = resultObj.phenology || "";
    const month = resultObj.month || "";
    const scores = resultObj.scores || {};
    const correctedScores = resultObj.correctedScores || {};

    // è·å–æ¨¡æ¿
    const template = DIAGNOSTICS_CONFIG.diagnosis_templates[diagnosis];
    if (!template) {
      console.error("âŒ æœªæ‰¾åˆ°è¯Šæ–­æ¨¡æ¿ï¼š", diagnosis);
      wx.showToast({ title: "è¯Šæ–­æ¨¡æ¿ç¼ºå¤±", icon: "none" });
      return;
    }

    // æ›´æ–°é¡µé¢æ¸²æŸ“æ•°æ®
    this.setData({
      diagnosis,
      diagnosisName: template.name,
      mechanism: template.mechanism,
      treatment: template.treatment,
      scores,
      correctedScores,
      phenology,
      month
    });

    console.log("ã€ResultPageã€‘é¡µé¢æ•°æ®åˆå§‹åŒ–å®Œæˆ");
  },

  // è¿”å›é¦–é¡µ
  goBack() {
    wx.navigateBack({ delta: 2 });
  },

  // é‡æ–°è¯Šæ–­
  reDiagnose() {
    wx.navigateBack({ delta: 1 });
  },

  // æ ¹æ®ç‰©å€™è‹±æ–‡è·å–ä¸­æ–‡å
  getPhenologyName(phenology) {
    const names = {
      overwinter: 'è¶Šå†¬æœŸ',
      budding: 'èŒèŠ½æœŸ',
      budding_flowering: 'æ˜¥æ¢¢+åˆèŠ±æœŸ',
      flowering_fruit_drop: 'ç››èŠ±+ç”Ÿç†è½æœæœŸ',
      fruit_drop_summer_rain: 'è½æœ+é›¨å­£å¼€å§‹',
      summer_rain: 'é«˜æ¸©å¤šé›¨ç–«éœ‰æœŸ',
      flower_induction: 'èŠ±èŠ½åˆ†åŒ–æœŸ',
      autumn_flush: 'ç§‹æ¢¢æœŸ',
      fruit_expansion: 'æœå®è†¨å¤§&è½¬è‰²æœŸ'
    };
    return names[phenology] || phenology;
  }
});
